#!/usr/bin/env bash
set -euo pipefail

# Universal paste utility - detects platform and clipboard method automatically

# Detect operating system
detect_os() {
    if [[ -f /proc/version ]] && grep -qi microsoft /proc/version; then
        echo "wsl"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if [[ -n "${WAYLAND_DISPLAY:-}" ]]; then
            echo "wayland"
        elif [[ -n "${DISPLAY:-}" ]]; then
            echo "x11"
        else
            echo "linux-headless"
        fi
    elif [[ "$OSTYPE" == "cygwin" ]] || [[ "$OSTYPE" == "msys" ]]; then
        echo "windows"
    else
        echo "unknown"
    fi
}

# Paste from clipboard based on platform
paste_clipboard() {
    local os_type
    os_type=$(detect_os)
    
    case "$os_type" in
        wsl)
            # WSL - use PowerShell
            if command -v powershell.exe >/dev/null 2>&1; then
                powershell.exe -command "Get-Clipboard" 2>/dev/null | tr -d '\r'
                return 0
            fi
            ;;
        
        macos)
            # macOS - use pbpaste
            if command -v pbpaste >/dev/null 2>&1; then
                pbpaste
                return 0
            fi
            ;;
        
        wayland)
            # Wayland - try wl-paste
            if command -v wl-paste >/dev/null 2>&1; then
                wl-paste 2>/dev/null
                return 0
            fi
            ;;
        
        x11)
            # X11 - try multiple tools in order of preference
            if command -v xclip >/dev/null 2>&1; then
                xclip -selection clipboard -o 2>/dev/null
                return 0
            elif command -v xsel >/dev/null 2>&1; then
                xsel --clipboard --output 2>/dev/null
                return 0
            fi
            ;;
        
        windows)
            # Native Windows (Git Bash, Cygwin, MSYS2)
            if command -v powershell.exe >/dev/null 2>&1; then
                powershell.exe -command "Get-Clipboard" 2>/dev/null | tr -d '\r'
                return 0
            elif command -v clip.exe >/dev/null 2>&1; then
                # clip.exe is for copy only, try getting from temp file
                echo "clip.exe cannot paste, only copy" >&2
                return 1
            fi
            ;;
    esac
    
    # Fallback: Check tmux
    if [[ -n "${TMUX:-}" ]] && command -v tmux >/dev/null 2>&1; then
        tmux save-buffer - 2>/dev/null && return 0
    fi
    
    # Ultimate fallback: Check if we're in a terminal that might support bracketed paste
    echo "Error: No clipboard tool found for platform: $os_type" >&2
    echo "" >&2
    echo "Please install one of the following:" >&2
    case "$os_type" in
        macos)
            echo "  - pbpaste should be pre-installed" >&2
            ;;
        wayland)
            echo "  - wl-clipboard: sudo apt install wl-clipboard" >&2
            ;;
        x11)
            echo "  - xclip: sudo apt install xclip" >&2
            echo "  - xsel: sudo apt install xsel" >&2
            ;;
        linux-headless)
            echo "  - tmux (then use tmux clipboard)" >&2
            echo "  - Or use SSH with local clipboard forwarding" >&2
            ;;
        *)
            echo "  - Platform-specific clipboard tool" >&2
            ;;
    esac
    return 1
}

# Main execution
paste_clipboard
