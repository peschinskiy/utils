#!/usr/bin/env python3
import sys
import subprocess
import tempfile
import os
import re


def get_vtt(url, arg):
    with tempfile.TemporaryDirectory() as tmpdir:
        result = subprocess.run(
            [
                'yt-dlp',
                '--skip-download',
                arg,
                '--sub-lang', 'en',
                '--sub-format', 'vtt',
                '-o', os.path.join(tmpdir, '%(id)s.%(ext)s'),
                url,
            ],
            stderr=sys.stderr,
        )
        if result.returncode != 0:
            return None
        for fname in os.listdir(tmpdir):
            if fname.endswith('.vtt'):
                with open(os.path.join(tmpdir, fname)) as f:
                    return f.read()
    return None


def parse_vtt(vtt):
    lines = []
    in_cue = False
    for line in vtt.split('\n'):
        line = line.strip()
        if '-->' in line:
            in_cue = True
            continue
        if in_cue and line:
            clean = re.sub(r'<[^>]+>', '', line)
            if clean:
                lines.append(clean)
        elif not line:
            in_cue = False

    # Remove consecutive duplicates
    result = []
    prev = None
    for line in lines:
        if line != prev:
            result.append(line)
            prev = line
    return result


def main():
    if len(sys.argv) != 2:
        print('Usage: getsubs <url>', file=sys.stderr)
        sys.exit(1)

    url = sys.argv[1]

    vtt = get_vtt(url, '--write-sub') or get_vtt(url, '--write-auto-sub')

    if not vtt:
        print('no subs found', file=sys.stderr)
        sys.exit(1)

    for line in parse_vtt(vtt):
        print(line)


if __name__ == '__main__':
    main()
